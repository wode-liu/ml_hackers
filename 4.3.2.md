##为排名算法构造一个权重策略
在我们开始构造权重策略之前，我们需要离题简要的讨论一下规模问题。想一想你自己的邮件行为。你几乎定期的与相同的一群人收发邮件吗？你知道你一天之内接收多少邮件吗？你每周从陌生人那里收到多少邮件？如果你和我们差不多，像大多数人那样，粗略的算起来，你的邮件大概是二八开。也就是说，大约有八成的邮件是与你的通讯录里面二成的人交互的。那么，为什么这个很重要呢？  

我们需要设计出一个权衡数据中特定特征权重的策略，但是由于这些特征在规模上有潜在的不同之处，我们不能将其直接比较。更确切地说，我们不能直接比较他们的绝对值。我们看看刚刚解析完的训练数据。已知我们加入到排名算法的一个特征是基于训练数据中来自每个邮件地址的邮件数量得到的社交交互的近似特征。  

    from.weight <- ddply(priority.train, .(From.EMail), summarise, Freq=length(Subject))

为了考察这个规模是如何影响第一个特征的，我们需要为在数据中出现的每个邮件地址出现的次数计数。为此，我们需要调用plyr包，我们在ggplot2中已经作为依赖包将其加载了。如果你作过第一章中的例题，你就已经见过plyr的实际运用了。简单地说plyr中的函数族是用来将数据分割成小块，使得我们可以一次就处理这些成块的数据。（这与在很多在大规模数据分析环境中流行的Map-Reduce范式类似）。这里只有一个简单的任务：找到所有的与From.Email维中的邮箱地址匹配的列并计数。  

为此，我们对训练数据使用ddply函数，该函数在数据帧上操作。语法要求我们先定义我们想要的数据分组--这里指的是From.EMail维，然后再定义我们将要在分组上进行的操作。我们利用计数信息用summarise选项构造一个名为Freq的新的列。你可以用head（from.weight）命令来检查结果。  

    在这里，这些操作需要分割后的数据中Subject列的向量的长度，但是事实上我们本可以使用来自训练数据的任何列来得到相同的结果，因为满足我们的条件的所有列都有相同的长度。更加熟练的使用plyr操纵数据对你接下来的学习是非常重要的，我们强烈推荐你阅读这个包的作者的文档。

为了更好的了解这个数据的规模，我们将结果展示在图中。图4-2是一个给用户发送超过6个邮件的数量的柱状图。我们这样截断不显示6个邮件以下的数据是为了更容易阅读，但是即便去除了一些数据，我们也看到了这个数据增长很快。发送最多的发件人tim.one@comcast.ent在这个数据中发送了45个邮件。那大概是训练数据中平均发件人的15倍！但是time.one@comcast.ent很特别。你可以在图4-2中看到，只有很少的发件人能达到他的水平，并且其后的频率下降很快。我们怎么才能为一个在训练数据中平均水平的发件人权重并避免向那些类似于发送最多邮件的发件人这样的值偏斜呢？  

![Figure 4-2](images/figure 4-2.png?raw=true)

###对数权重策略
解决的方法是转换比例。我们需要让特征集中的单元之间的数值关系不那么极端。如果直接比较绝对频率计数，那么一个来自于tim.one@comcast.ent的邮件的重要性权重会是一个来自于一般发件人的15倍。这是非常让人觉得有问题的，因为我们想要基于来自学习部分的排序算法产生的权重值范围，设立一个阈值决定一个邮件是否优先。如果有这样极端的偏斜，阈值就要么会太低要么会太高，因此需要重新调节这些单元以解释我们数据的本质。  

很自然的我们就想到对数和对数转化。你可能对初等数学中的对数很熟悉，如果不是的话，这个概念非常简单。对数是返回会满足底数的乘方次数等于那个指数等式的指数值的函数。  

底数在对数转换中是至关重要的。作为黑客，我们总是用二进制思考。我们可能非常容易建立一个以2为底的对数转换。这时，我们可以解2的输入值次方等于那个指数的指数方程。例如，如果我们使用2为底的对数转换来转换16，就会得到4，因为2的4次方等于16。总的来说，我们是在做指数运算的逆运算，因此这些类型的转换操作在数据适合这样方程的时候效果最好。  

最普通的两种对数转换是被称为“自然对数”和“10为底对数”的转换。前者的底数是特殊值e，那是一个类似于pi的无理常数，约等于2.718。自然对数通常用ln表示。这种常数的变换率在自然界中是经常可见的，事实上这是可以从圆内角度方程用几何学的方法推到出来。你可能对图形及遵循自然对数的关联很熟悉，只是你从来没这样想过。图4-3是一个自然对数的螺旋，这可以在自然发生的很多现象中观察到。例如鹦鹉螺壳的内部构造和龙卷风的罗旋风。甚至是我们银河系的行星分布也遵循自然对数的螺旋。并且，很多专业相机设置的光圈都是由自然对数设定的。  

知道了这个值和很多自然现象的紧密关系，可以将其作为重新调节我们指数形式社交数据的很好的方程，比如邮件活动。此外，10为底的对数就是将自然对数转换中的e替为10，通常用log10表示。知道了对数转换是怎样工作的，我们就明白以10为底的对数转换比自然对数转换将大数转为更小的值。例如，10为底的对数转换将1000转为3，因为10的三次方是1000，而自然对数转换的结果约等于6.9。因此，当我们的数据范围更大的时候使用以10为底的对数转换更加合理。  

图4-4中是两种将邮件数量数据转换的两种方式。在图中，我们可以看出训练数据中用户发送的邮件数目遵循一种很陡峭的指数形式。通过自然对数和10为底对数转换这些数值，我们可以将曲线明显的变平缓。正如我们所说的，10为底对数砖混会大幅的转换数值，然而自然对数转换仍然会提供一些可以让我们从训练数据中提取有用权重的变量。因此，我们好似用自然对数来定义邮件数量特征的权重。  

![Figure 4-3](images/figure 4-3.png?raw=true)

